# 规则符合性分析

## 概述

本文档对照 GAME_RULE.md 分析现有实现的规则符合性，标记已实现、需要验证和缺失的规则。

## 分析日期

2025-11-04

## 规则对比

### ✅ 已正确实现的规则

#### 1. 手牌规则
- **规则**: 3副牌，去掉3、4、大小王，共132张。铺9张，每人41张
- **实现**: `GameConfig.create_standard_3deck_3player()` ✅
- **位置**: `src/datongzi_rules/variants/config_factory.py:60-77`
- **测试**: `tests/unit/test_variants.py:test_standard_3deck_3player()`

#### 2. 玩家数
- **规则**: 3人
- **实现**: `config.num_players = 3` ✅
- **位置**: `src/datongzi_rules/models/config.py`
- **测试**: ✅ 已有

#### 3. 炸弹（Bomb）
- **规则**: 4个或4个以上相同数字，大打小，多打少（4个2打4个A，5个打4个）
- **实现**: `PatternRecognizer._check_bomb()` ✅
- **比较逻辑**: `PlayValidator._compare_patterns()` - 先比点数，再比数量 ✅
- **位置**: `src/datongzi_rules/patterns/recognizer.py:298-316, 459-467`
- **测试**: ⚠️ 需要补充详细测试

#### 4. 筒子（Tongzi）
- **规则**: 3张同花色同数字，压炸弹，花色优先级：黑桃>红桃>梅花>方块
- **实现**: `PatternRecognizer._check_tongzi()` ✅
- **比较逻辑**: 先比点数，再比花色 ✅
- **位置**: `src/datongzi_rules/patterns/recognizer.py:318-340, 435-457`
- **花色顺序**: `Suit.SPADES(4) > HEARTS(3) > CLUBS(2) > DIAMONDS(1)` ✅
- **测试**: ⚠️ 需要补充花色比较测试

#### 5. 地炸（Dizha）
- **规则**: 同数字的4种花色各2张（共8张），2地炸最大
- **实现**: `PatternRecognizer._check_dizha()` ✅
- **位置**: `src/datongzi_rules/patterns/recognizer.py:342-369`
- **测试**: ⚠️ 需要补充测试

#### 6. 连对（Consecutive Pairs）
- **规则**: 两连对以上可以出（包括两连对）
- **实现**: `PatternRecognizer._check_consecutive_pairs()` ✅
- **位置**: `src/datongzi_rules/patterns/recognizer.py:162-186`
- **测试**: ⚠️ 需要补充边界测试

#### 7. 三张牌（Triple with Two）
- **规则**: 可以带两张出（只能少带，不能多带）
- **实现**: `PatternRecognizer._check_triple_with_two()` ⚠️
- **问题**: 代码要求必须是5张（3+2），不支持"少带"
- **位置**: `src/datongzi_rules/patterns/recognizer.py:207-234`
- **测试**: ❌ 缺少少带测试

#### 8. 飞机（Airplane）
- **规则**: 数字连续的3张，可以飞机带翅膀（每组可以带2张，可以少带）
- **实现**:
  - `PatternRecognizer._check_airplane()` - 纯飞机 ✅
  - `PatternRecognizer._check_airplane_with_wings()` - 飞机带翅膀 ✅
- **少带支持**: 代码支持少带 ✅
- **位置**: `src/datongzi_rules/patterns/recognizer.py:236-295`
- **测试**: ⚠️ 需要补充详细测试

#### 9. 有牌必打
- **规则**: 打得起则必须打
- **实现**: `config.must_beat_rule` ✅
- **位置**: `src/datongzi_rules/models/config.py`
- **测试**: ❌ 缺少游戏流程测试

#### 10. 计分规则 - 基础分
- **规则**: 5=5分，10=10分，K=10分，回合胜利者得分
- **实现**: `Card.is_scoring_card`, `Card.score_value` ✅
- **位置**: `src/datongzi_rules/models/card.py:52-64`
- **测试**: ✅ 已有

#### 11. 完成位置奖励
- **规则**: 上游+100，二游-40，三游-60
- **实现**: `config.finish_bonus = [100, -40, -60]` ✅
- **位置**: `src/datongzi_rules/variants/config_factory.py:74`
- **测试**: ✅ 已有

### ⚠️ 实现有问题的规则

#### 1. 单牌顺子规则
- **规则**: "单牌顺子不能出"
- **现状**: 代码中没有STRAIGHT类型，默认不支持 ✅
- **建议**: 添加明确的测试验证单牌顺子被拒绝

#### 2. 三张带牌规则
- **规则**: "只能少带，不能多带"
- **问题**: 代码只支持精确3+2，不支持3+0或3+1
- **位置**: `src/datongzi_rules/patterns/recognizer.py:207-234`
- **修复建议**:
  - 保留现有TRIPLE_WITH_TWO（3+2）
  - TRIPLE（3+0）已存在
  - 考虑是否需要3+1的情况

#### 3. 飞机带翅膀规则
- **规则**: "每一组都可以带2张（可以少带）"
- **实现**: 代码支持少带 ✅
- **验证**: 需要测试确认

### ❌ 严重缺失的规则

#### 1. 筒子/地炸奖励计分时机 ⚠️⚠️⚠️

**规则原文**:
> 需要注意的是，只有一轮牌的最后一手牌才能计算分数，假如A出牌K筒子，B出牌A筒子，假如其他玩家没有比该A筒子更大的手牌，那么B得到该200分，A不得分。

**问题**:
- 现有代码 `ScoringEngine.create_special_bonus_events()` 会给任何打出筒子/地炸的玩家计分
- 没有判断是否是回合最后一手牌
- **这是严重的规则bug！**

**影响**:
- 所有筒子/地炸的奖励分计算都是错误的
- 如果A打K筒子被B的A筒子压死，A仍然会得到100分（错误！）

**修复方案**:
1. 修改 `create_special_bonus_events()` 签名，添加 `is_round_winning_play` 参数
2. 只有当 `is_round_winning_play=True` 时才计算筒子/地炸奖励
3. 游戏流程层需要正确传入这个标志

**受影响文件**:
- `src/datongzi_rules/scoring/engine.py:116-170`
- 所有调用此方法的代码

#### 2. 筒子压死筒子不累积分数

**规则原文**:
> 当局筒子压死筒子不累积分数。若A方被B方击败，B方得奖励分。

**问题**:
- 这个规则和上面的规则是同一个问题
- 只有回合最后一手牌才计分，自然解决了这个问题

**修复**:
- 同上

#### 3. 回合制逻辑

**规则原文**:
> 一个回合就是某个玩家出牌后，经过N轮出牌后，其他玩家没有再出牌，在有牌必出的规则下，就是其他玩家没有比该玩家当前出牌更大的牌，此时回合结束，最后出牌的玩家则为该回合的胜利者。

**问题**:
- 规则引擎只提供了牌型识别和验证，没有完整的回合制游戏流程
- 缺少游戏状态管理
- 缺少回合管理
- 缺少有牌必打的强制逻辑

**修复**:
- 需要创建 `GameEngine` 或 `GameSimulator` 类来管理完整游戏流程

## 测试覆盖情况

### 当前测试统计
- 单元测试：95 个
- 集成测试：6 个
- 覆盖率：79.98%

### 缺失的测试类别

#### 1. 牌型识别详细测试
- ❌ 连对边界测试（2对、3对、4对、5对）
- ❌ 三带二边界测试
- ❌ 飞机详细测试（2组、3组、4组）
- ❌ 飞机带翅膀少带测试
- ❌ 非法牌型测试（单牌顺子、不连续的对子等）

#### 2. 出牌验证详细测试
- ❌ 炸弹vs炸弹（所有组合）
  - 4个5 vs 4个2（点数大）
  - 5个5 vs 4个5（数量多）
  - 5个5 vs 4个K（数量多打点数大）
- ❌ 筒子vs炸弹（所有组合）
- ❌ 筒子vs筒子（花色比较）
  - 同点数不同花色
  - 不同点数
- ❌ 地炸vs所有牌型
- ❌ 连对长度验证
- ❌ 飞机组数验证

#### 3. 计分系统测试
- ❌ 回合最后一手牌的筒子/地炸计分
- ❌ 中间手牌的筒子/地炸不计分
- ❌ 筒子被压死不计分测试
- ❌ 完整游戏流程计分

#### 4. 游戏流程测试
- ❌ 完整回合流程
- ❌ 有牌必打强制规则
- ❌ 游戏结束条件
- ❌ 多回合游戏模拟

## 优先级排序

### P0 - 关键缺陷（必须修复）
1. **修复筒子/地炸计分时机** - 规则bug
2. **创建游戏流程模拟器** - 验证完整规则
3. **补充计分系统测试** - 验证修复正确性

### P1 - 高优先级（应该补充）
1. **补充牌型识别边界测试** - 提高覆盖率
2. **补充出牌验证详细测试** - 验证所有规则
3. **创建完整对战测试** - 端到端验证

### P2 - 中优先级（建议补充）
1. **非法牌型测试** - 边界情况
2. **性能压力测试** - 生产准备

## 修复计划

### Phase 1: 修复关键缺陷（预计3小时）

1. **修改计分引擎**
   - 添加 `is_round_winning_play` 参数
   - 只对回合最后一手牌计算特殊奖励
   - 编写单元测试验证

2. **创建游戏流程模拟器**
   - GameSimulator类
   - 管理回合状态
   - 实现有牌必打
   - 正确调用计分系统

3. **验证修复**
   - 模拟完整游戏
   - 验证计分正确性

### Phase 2: 补充测试（预计2小时）

1. **牌型识别测试**
   - 所有牌型的边界测试
   - 非法牌型测试

2. **出牌验证测试**
   - 所有牌型对比组合
   - 边界情况

3. **计分系统测试**
   - 所有计分场景

### Phase 3: 完整对战测试（预计1小时）

1. **创建完整对战测试**
   - 多回合游戏
   - 所有规则验证
   - 每一步监控

## 文件修改清单

### 需要修改的文件
1. `src/datongzi_rules/scoring/engine.py` - 添加计分时机判断
2. 新增 `src/datongzi_rules/simulation/game_simulator.py` - 游戏流程模拟器
3. 新增 `tests/unit/test_patterns_comprehensive.py` - 全面的牌型测试
4. 新增 `tests/unit/test_validator_comprehensive.py` - 全面的验证测试
5. 新增 `tests/unit/test_scoring_comprehensive.py` - 全面的计分测试
6. 新增 `tests/integration/test_full_game_simulation.py` - 完整游戏模拟测试

### 测试目标
- 总测试数：从106个增加到200+个
- 覆盖率：从79.98%提升到90%+
- 确保所有规则100%符合GAME_RULE.md

## 结论

现有实现基本正确，但存在一个严重的规则缺陷：

**筒子/地炸奖励计分时机错误** - 这是必须立即修复的P0级别bug。

其他部分主要是测试覆盖不足，需要补充全面的单元测试和集成测试来验证规则符合性。
